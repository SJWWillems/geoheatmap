---
title: "Introduction to geoheatmap"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to geoheatmap}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r positioning of logo, echo= FALSE, warning=FALSE}
library(knitr)

logo_path <- system.file("internal/geoheatmap.png", package = "geoheatmap")
logo_uri <- image_uri(logo_path)
htmltools::img(src = logo_uri, 
               alt = 'logo', 
               style = 'position:absolute; top:17px; right:17px; width:170px; border:none; outline:none')
```


The geoheatmap R package aims to provide an easy way for building cartogram heatmaps for regions worldwide. 

We took inspiration from the aesthetically made graphs in [statebins](https://github.com/hrbrmstr/statebins), and extended on its functionality by allowing for user-defined grids, which means that the cartogram heatmaps can now represent territories outside the US. Though any well-defined grid will technically work, grids from  [geofacet](https://github.com/hafen/geofacet) are an excellent starting point.


## Installation and Setup

```{r, eval= FALSE}
install.packages("geoheatmap")
```

```{r setup, message=FALSE}
library(geoheatmap)
library(geofacet)
library(viridisLite)
library(plotly)
```

The use of package viridisLite here is to make colour-blind friendly graphical options for the examples below. 

## Usage

The data used for all examples is available in the geoheatmap package under the name `internet`.

```{r}
data(internet, package = "geoheatmap")
head(internet)
```

Internet.rda lists a good chunk of countries worldwide, in an alphabetical and chronological order (1990 - 2016), with the rightmost column depicting percentage of individuals in a given country having used internet in some capacity in previous 3 months. 

### Continuous scale examples

```{r, message= FALSE, fig.width= 8, fig.height= 6}
internet_2015 <- subset(internet, year == 2015)
one <- geoheatmap(facet_data= internet_2015, grid_data= europe_countries_grid1,
           facet_col = "country", value_col = "users", 
           low = "#56B1F7", high = "#132B43")
one + labs(title = "2015 Internet Usage in Europe")

```
This graph shows a gradient internet usage across Europe. Though most countries are well above the halfway mark of population internet use, highest percentages can be found in Northwestern European countries.

Let's look at another example:

```{r, message= FALSE, fig.width= 8, fig.height= 6}
two <- geoheatmap(facet_data = internet_2015, 
           grid_data = europe_countries_grid1,
           facet_col = "country", 
           value_col = "users",
           name = "Internet users: divergent",
           ggplot2_scale_function = scale_fill_gradient2, 
           low =  viridis(10)[1], 
           mid = "white", 
           high = viridis(10)[8], 
           midpoint = 75,  
           round = TRUE)
two + labs(title = "2015 Internet Usage in Europe")
```

You can use `round= TRUE` to give a rounded look to the tiles. 
In addition, you are of course not limited to the default ggplot2 scale function, and changes to it, as well as additional arguments, get passed down directly inside the function. 

### Discrete scale examples

Of course, different grids are a possibility, so let's turn to the African continent for the next couple of examples. We make use of the `africa_countries_grid1`, and for a comprehensive overview of available grids, see section below. 

```{r, message= FALSE, fig.width= 8, fig.height= 6}

three <- geoheatmap(facet_data= internet_2015, grid_data= africa_countries_grid1,
           facet_col = "country", value_col = "users",
           name= "Internet users: binned",
           ggplot2_scale_function = scale_fill_binned,
           type= "viridis")
three + labs(title = "Internet Usage in Africa")

```

This graph shows how African countries differed in using the internet in year 2015, possibly tied to economic development of a given country. Bins were created automatically.

You can make up your own preferred breaks:

```{r, message= FALSE, fig.width= 8, fig.height= 6}
internet_2015$users_bin= cut(internet_2015$users, breaks = c(-Inf, 25, 50, Inf), labels = c("0-25", "26-50", "51 and up"))

four <- geoheatmap(facet_data= internet_2015, grid_data= africa_countries_grid1,
           facet_col = "country", value_col = "users_bin",
           name= "Internet users: binned",
           ggplot2_scale_function = scale_fill_brewer,
           type = "seq", palette= "Greens", na.value= "grey50" )
four + labs(title = "Internet Usage in Africa")
```
With the manual breaks, it's a bit easier to spot that four countries surpassed the halfway mark of population Internet usage: Morocco, Mauritius, Seychelles and South Africa.

### Grid language options

Sometimes, grids have local as well as anglophone location names, with the default being set to the latter. If you would like to use the regional version (e.g. because your data frame operates with native names), you can pass it in as an additional argument using `merge_col`.

```{r}
de_states_grid1
```
Note, for example, how the German states grid has both `name` and `name_de` columns, with diverging state names in most cases. For illustration purposes, let's make up a dataset that works with state names native to a German speaker. 

```{r dummy german, fig.width= 8, fig.height= 6}
# Dummy data frame with German states and number of football teams
football_teams= data.frame(
  state = c(
    "Baden-Württemberg", "Bayern", "Berlin", "Brandenburg",
    "Bremen", "Hamburg", "Hessen", "Mecklenburg-Vorpommern",
    "Niedersachsen", "Nordrhein-Westfalen", "Rheinland-Pfalz",
    "Saarland", "Sachsen", "Sachsen-Anhalt", "Schleswig-Holstein",
    "Thüringen"
  ),
  teams = c(18, 22, 8, 6, 4, 5, 14, 3, 12, 28, 10, 3, 9, 5, 7, 4)
)

five <- geoheatmap(facet_data= football_teams,
        grid_data= de_states_grid1,
        facet_col = "state",value_col = "teams",merge_col = "name_de",
        name= "No. of teams",
        low = "lightblue", high = plasma(2)[1],
        round = TRUE)
five + labs(title = "Football teams in German states")

```

By specifying merge_col = "name_de", the `geoheatmap()` function merges proper data set and grid columns together before producing a plot. 
Though purely fictional, this plot shows that Nordrhein-Westfalen state is leading in number of football teams, something the authors suspect to be true regardless, as the state is Germany's most populous. 

### Interactive plots

You also have the option to make any given plot created with `geoheatmap()` interactive with plotly directly in the function call, by specifying `hover = TRUE `. 

```{r intercative, fig.width= 8, fig.height= 6}
geoheatmap(facet_data= football_teams,
        grid_data= de_states_grid1,
        facet_col = "state",value_col = "teams",merge_col = "name_de",
        name= "No. of teams",
        low = "lightblue", high = plasma(2)[1],
        hover = TRUE)
```

Note that the custom geoms created in the `statebins` package are not yet implemented in `plotly`, which means that calling `round = TRUE` in conjunction with `hover = TRUE` does not work (yet).

```{r false intercatice, fig.width=4, fig.height=2}
geoheatmap(facet_data= football_teams,
        grid_data= de_states_grid1,
        facet_col = "state",value_col = "teams",merge_col = "name_de",
        name= "No. of teams",
        low = "lightblue", high = plasma(2)[1],
        round = TRUE,
        hover = TRUE)
```

### List available grids

To get the list of names of available grids in the geofacet package so far, call:

```{r}
geofacet::get_grid_names()
```

This list is constantly being updated as authors of the geofacet made uploading your own grids possible. You can learn how to submit your own by following the steps in next section.

### Creating your own grid

For detailed instructions on creating a custom grid, see the "Creating your own grid" section in the `geofacet` vignette. You can find it at: https://cran.r-project.org/web/packages/geofacet/vignettes/geofacet.html

### Theme

The default theme is set to `theme_void()`, but this can be either overwritten, or added onto depending on intended
plot purposes.



